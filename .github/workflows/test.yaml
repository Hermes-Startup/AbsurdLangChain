name: Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  NODE_VERSION: '20'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run tests
        run: yarn test
        continue-on-error: false

      - name: Notify Hermes Interview System
        if: success()
        run: |
          # Check if config exists (gracefully skip if not interview repo)
          if [ ! -f .hermes/config.json ]; then
            echo "‚ö†Ô∏è  .hermes/config.json not found - skipping Hermes notification"
            echo "‚ÑπÔ∏è  This is normal for non-interview repositories"
            exit 0
          fi
          
          # Read config
          SESSION_ID=$(jq -r .sessionId .hermes/config.json)
          API_BASE_URL=$(jq -r .apiBaseUrl .hermes/config.json)
          
          if [ "$SESSION_ID" == "null" ] || [ -z "$SESSION_ID" ] || [ "$SESSION_ID" == "session_EXAMPLE_REPLACE_WITH_ACTUAL_SESSION_ID" ]; then
            echo "‚ö†Ô∏è  Invalid or missing sessionId - skipping Hermes notification"
            exit 0
          fi
          
          if [ "$API_BASE_URL" == "null" ] || [ -z "$API_BASE_URL" ]; then
            echo "‚ö†Ô∏è  Invalid or missing apiBaseUrl - skipping Hermes notification"
            exit 0
          fi
          
          echo "üì§ Notifying Hermes orchestrator..."
          echo "   Session ID: $SESSION_ID"
          echo "   API URL: $API_BASE_URL/test"
          
          # Notify Hermes that tests passed
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$API_BASE_URL/test" \
            -H "Content-Type: application/json" \
            -d "{
              \"sessionId\": \"$SESSION_ID\",
              \"testData\": {
                \"status\": \"success\",
                \"conclusion\": \"success\",
                \"head_sha\": \"${{ github.sha }}\",
                \"workflow_run_id\": \"${{ github.run_id }}\",
                \"workflow_name\": \"${{ github.workflow }}\",
                \"details_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
                \"repository\": \"${{ github.repository }}\"
              }
            }")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ Hermes notification sent successfully (HTTP $HTTP_CODE)"
            echo "Response: $BODY"
          else
            echo "‚ö†Ô∏è  Hermes notification may have failed (HTTP $HTTP_CODE)"
            echo "Response: $BODY"
            # Don't fail the workflow - this is non-critical
          fi
