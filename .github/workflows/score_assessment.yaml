# .github/workflows/score_assessment.yaml
#
# This workflow runs after a candidate submits their assessment.
# It calculates automated scores and submits them to Supabase.
#
# Trigger manually or on push to main (after candidate submits PR).

name: Score Assessment

on:
  workflow_dispatch:
    inputs:
      candidate_id:
        description: 'Candidate ID (GitHub username)'
        required: true
        type: string
  push:
    branches:
      - main
    paths:
      - 'app/insights/**'

env:
  NODE_VERSION: '20'

jobs:
  score:
    name: Calculate Assessment Score
    runs-on: ubuntu-latest
    
    outputs:
      total_score: ${{ steps.calculate.outputs.total_score }}
      completion_score: ${{ steps.completion.outputs.completion_score }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for velocity analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
            node_modules/.cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}-
            ${{ runner.os }}-nextjs-

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run Assessment Tests
        id: tests
        run: |
          # Run vitest with JSON reporter to get structured results
          yarn test:score 2>&1 || true
          
          # Parse test results and output scores
          if [ -f "test-results.json" ]; then
            echo "âœ… Test results generated"
            
            # Parse results using node
            node -e "
              const fs = require('fs');
              const results = JSON.parse(fs.readFileSync('test-results.json', 'utf-8'));
              
              // Count passed/failed tests per category
              let scores = {
                build: { passed: 0, total: 0 },
                completion: { passed: 0, total: 0 },
                enhanced: { passed: 0, total: 0 },
                sabotage: { passed: 0, total: 0 }
              };
              
              // Process test files
              for (const file of results.testResults || []) {
                const fileName = file.name || '';
                let category = 'completion';
                
                if (fileName.includes('build')) category = 'build';
                else if (fileName.includes('enhanced')) category = 'enhanced';
                else if (fileName.includes('sabotage')) category = 'sabotage';
                
                for (const test of file.assertionResults || []) {
                  scores[category].total++;
                  if (test.status === 'passed') {
                    scores[category].passed++;
                  }
                }
              }
              
              // Calculate point scores
              const buildScore = Math.round((scores.build.passed / Math.max(scores.build.total, 1)) * 15);
              const completionScore = Math.round((scores.completion.passed / Math.max(scores.completion.total, 1)) * 35);
              const enhancedScore = Math.round((scores.enhanced.passed / Math.max(scores.enhanced.total, 1)) * 25);
              const hasSqlIndex = scores.sabotage.passed > 0;
              
              console.log('BUILD_SCORE=' + buildScore);
              console.log('COMPLETION_SCORE=' + completionScore);
              console.log('ENHANCED_SCORE=' + enhancedScore);
              console.log('HAS_SQL_INDEX=' + hasSqlIndex);
              console.log('BUILD_TESTS=' + scores.build.passed + '/' + scores.build.total);
              console.log('COMPLETION_TESTS=' + scores.completion.passed + '/' + scores.completion.total);
              console.log('ENHANCED_TESTS=' + scores.enhanced.passed + '/' + scores.enhanced.total);
            " > test-scores.txt
            
            # Read scores into GitHub outputs
            BUILD_SCORE=$(grep 'BUILD_SCORE=' test-scores.txt | cut -d= -f2)
            COMPLETION_SCORE=$(grep 'COMPLETION_SCORE=' test-scores.txt | cut -d= -f2)
            ENHANCED_SCORE=$(grep 'ENHANCED_SCORE=' test-scores.txt | cut -d= -f2)
            HAS_SQL_INDEX=$(grep 'HAS_SQL_INDEX=' test-scores.txt | cut -d= -f2)
            
            echo "build_score=${BUILD_SCORE:-0}" >> $GITHUB_OUTPUT
            echo "completion_score=${COMPLETION_SCORE:-0}" >> $GITHUB_OUTPUT
            echo "enhanced_score=${ENHANCED_SCORE:-0}" >> $GITHUB_OUTPUT
            echo "has_sql_index=${HAS_SQL_INDEX:-false}" >> $GITHUB_OUTPUT
            
            echo ""
            echo "========================================"
            echo "TEST RESULTS"
            echo "========================================"
            cat test-scores.txt
            echo "========================================"
          else
            echo "âŒ No test results found"
            echo "build_score=0" >> $GITHUB_OUTPUT
            echo "completion_score=0" >> $GITHUB_OUTPUT
            echo "enhanced_score=0" >> $GITHUB_OUTPUT
            echo "has_sql_index=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Calculate total score
        id: calculate
        run: |
          # Get scores from test results
          BUILD_SCORE=${{ steps.tests.outputs.build_score }}
          COMPLETION_SCORE=${{ steps.tests.outputs.completion_score }}
          ENHANCED_SCORE=${{ steps.tests.outputs.enhanced_score }}
          
          # Default to 0 if not set
          BUILD_SCORE=${BUILD_SCORE:-0}
          COMPLETION_SCORE=${COMPLETION_SCORE:-0}
          ENHANCED_SCORE=${ENHANCED_SCORE:-0}
          
          # Calculate subtotal
          SUBTOTAL=$((BUILD_SCORE + COMPLETION_SCORE + ENHANCED_SCORE))
          
          # Sabotage Detection: SQL Index penalty (-10 points)
          PENALTY=0
          if [ "${{ steps.tests.outputs.has_sql_index }}" == "false" ]; then
            PENALTY=10
            echo "âš ï¸  PENALTY: SQL Index removed (-10 points)"
          fi
          
          # Total (excluding reflection, which is scored separately)
          TOTAL_SCORE=$((SUBTOTAL - PENALTY))
          
          echo "build_score=$BUILD_SCORE" >> $GITHUB_OUTPUT
          echo "completion_score=$COMPLETION_SCORE" >> $GITHUB_OUTPUT
          echo "enhanced_score=$ENHANCED_SCORE" >> $GITHUB_OUTPUT
          echo "penalty=$PENALTY" >> $GITHUB_OUTPUT
          echo "total_score=$TOTAL_SCORE" >> $GITHUB_OUTPUT
          
          echo ""
          echo "========================================"
          echo "ASSESSMENT SCORE SUMMARY"
          echo "========================================"
          echo "Build & Types:    $BUILD_SCORE/15"
          echo "Completion:       $COMPLETION_SCORE/35"
          echo "Enhanced:         $ENHANCED_SCORE/25"
          echo "----------------------------------------"
          echo "Subtotal:         $SUBTOTAL/75"
          if [ "$PENALTY" -gt 0 ]; then
            echo "Penalty:          -$PENALTY (SQL Index removed)"
          fi
          echo "----------------------------------------"
          echo "TOTAL:            $TOTAL_SCORE/75"
          echo "========================================"


      - name: Submit scores to Supabase
        if: env.SUPABASE_URL != ''
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          CANDIDATE_ID="${{ inputs.candidate_id || github.repository_owner }}"
          WORKFLOW_RUN_ID="${{ github.run_id }}"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          # Build the artifact JSON
          ARTIFACT_JSON=$(cat <<EOF
          {
            "candidate_id": "$CANDIDATE_ID",
            "timestamp": "$TIMESTAMP",
            "scores": {
              "build_and_types": ${{ steps.calculate.outputs.build_score }},
              "completion": ${{ steps.calculate.outputs.completion_score }},
              "enhanced": ${{ steps.calculate.outputs.enhanced_score }},
              "total": ${{ steps.calculate.outputs.total_score }}
            },
            "metrics": {
              "penalty": ${{ steps.calculate.outputs.penalty }},
              "has_sql_index": ${{ steps.tests.outputs.has_sql_index }}
            },
            "workflow_run_id": "$WORKFLOW_RUN_ID",
            "workflow_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF
          )
          
          # Submit to Supabase
          curl -X POST "$SUPABASE_URL/rest/v1/rpc/log_assessment_score" \
            -H "apikey: $SUPABASE_KEY" \
            -H "Authorization: Bearer $SUPABASE_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"p_candidate_id\": \"$CANDIDATE_ID\",
              \"p_build_score\": ${{ steps.calculate.outputs.build_score }},
              \"p_completion_score\": ${{ steps.calculate.outputs.completion_score }},
              \"p_enhanced_score\": ${{ steps.calculate.outputs.enhanced_score }},
              \"p_total_score\": ${{ steps.calculate.outputs.total_score }},
              \"p_artifact_data\": $ARTIFACT_JSON,
              \"p_workflow_run_id\": \"$WORKFLOW_RUN_ID\"
            }"
          
          echo "âœ… Scores submitted to Supabase successfully"
          echo "ðŸ“Š Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Create score summary artifact
        run: |
          mkdir -p artifacts
          cat > artifacts/score-summary.json << EOF
          {
            "candidate_id": "${{ inputs.candidate_id || github.repository_owner }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "scores": {
              "build_and_types": ${{ steps.calculate.outputs.build_score }},
              "completion": ${{ steps.calculate.outputs.completion_score }},
              "enhanced": ${{ steps.calculate.outputs.enhanced_score }},
              "total": ${{ steps.calculate.outputs.total_score }}
            },
            "metrics": {
              "builds": ${{ steps.build.outputs.builds }},
              "type_errors": ${{ steps.typecheck.outputs.type_errors }},
              "locked_removed": ${{ steps.completion.outputs.locked_removed }},
              "has_fetch": ${{ steps.completion.outputs.has_fetch }},
              "shows_metrics": ${{ steps.completion.outputs.shows_metrics }},
              "has_highlighting": ${{ steps.completion.outputs.has_highlighting }},
              "has_sorting": ${{ steps.completion.outputs.has_sorting }},
              "has_loading": ${{ steps.completion.outputs.has_loading }},
              "has_gemini": ${{ steps.completion.outputs.has_gemini }},
              "has_sql_index": ${{ steps.sql_index.outputs.has_index }},
              "penalty": ${{ steps.calculate.outputs.penalty }}
            }
          }
          EOF
          
          cat artifacts/score-summary.json

      - name: Upload score artifact
        uses: actions/upload-artifact@v4
        with:
          name: assessment-score
          path: artifacts/score-summary.json
          retention-days: 90