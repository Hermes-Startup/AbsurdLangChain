name: ðŸ”’ POST_INTERVIEW_CLEANUP
on:
  workflow_dispatch:
    inputs:
      candidate_username:
        description: 'GitHub username of the candidate'
        required: true
        type: string
      interview_repo:
        description: 'Forked repository name (format: candidate-username/seed-repo)'
        required: true
        type: string
  schedule:
    # Run daily at 2 AM UTC to check for expired interviews
    - cron: '0 2 * * *'

jobs:
  revoke_access:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Archive Candidate Fork
        uses: actions/github-script@v7
        env:
          CANDIDATE_USERNAME: ${{ github.event.inputs.candidate_username || 'AUTO_DETECT' }}
          INTERVIEW_REPO: ${{ github.event.inputs.interview_repo || '' }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const candidateUsername = process.env.CANDIDATE_USERNAME;
            const interviewRepo = process.env.INTERVIEW_REPO;
            
            // If running on schedule, find all forks of this repo
            if (candidateUsername === 'AUTO_DETECT') {
              console.log('ðŸ” Auto-detecting forks to archive...');
              
              // Get all forks of the repository
              const forks = await github.rest.repos.listForks({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });
              
              console.log(`Found ${forks.data.length} fork(s)`);
              
              // Archive each fork (you can add time-based logic here)
              for (const fork of forks.data) {
                try {
                  // Note: You can't directly archive someone else's fork
                  // But you can make YOUR seed repo private to prevent new forks
                  console.log(`âš ï¸  Cannot archive ${fork.full_name} - candidate owns this fork`);
                  console.log(`ðŸ’¡ Solution: Make seed repo private or use Template Repository instead`);
                } catch (error) {
                  console.error(`Failed to process ${fork.full_name}:`, error.message);
                }
              }
            } else {
              console.log(`ðŸ”’ Processing cleanup for candidate: ${candidateUsername}`);
              console.log(`âš ï¸  Note: Cannot revoke access to fork ${interviewRepo}`);
              console.log(`ðŸ’¡ The candidate owns their fork. Consider:`);
              console.log(`   1. Making the seed repo private`);
              console.log(`   2. Using GitHub Template Repository instead of forks`);
            }

      - name: Make Seed Repo Private (Optional)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        env:
          MAKE_PRIVATE: ${{ github.event.inputs.make_private || 'false' }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            if (process.env.MAKE_PRIVATE === 'true') {
              await github.rest.repos.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                private: true
              });
              console.log('âœ… Seed repository is now private');
            }

      - name: Generate Cleanup Report
        run: |
          echo "## ðŸ”’ Post-Interview Cleanup Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Important Limitation" >> $GITHUB_STEP_SUMMARY
          echo "GitHub forks cannot be revoked - candidates own their forks." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Recommended Actions:" >> $GITHUB_STEP_SUMMARY
          echo "1. Make seed repo **private** to prevent new forks" >> $GITHUB_STEP_SUMMARY
          echo "2. Convert seed repo to **Template Repository** (better than forks)" >> $GITHUB_STEP_SUMMARY
          echo "3. Use GitHub API to create repos from template instead" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Make seed repo private: Settings â†’ Change visibility â†’ Make private" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Or convert to template: Settings â†’ Template repository (checkbox)" >> $GITHUB_STEP_SUMMARY

